<!DOCTYPE html>
<html>
    <head>
        <title>Simple Map</title>
        <meta name="viewport" content="initial-scale=1.0">
        <meta charset="utf-8">
        <style>
            html, body {
                height: 100%;
                margin: 0;
                padding: 0;
            }
            #map {
                height: 100%;
                z-index: 0;
            }
        </style>
        <script type="text/javascript" src="resources/json/coordinates.json"></script>
        <script type="text/javascript" src="resources/json/hospitals.json"></script>
        <script src="resources/js/jquery-3.0.0.min.js"></script>
        <script src="resources/bootstrap/js/bootstrap.min.js"></script>
        <link rel="stylesheet" href="resources/bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" href="resources/css/main.css">
    </head>
    <body>

        <nav class="navbar navbar-inverse" id="navbar">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span> 
                    </button>
                    <a class="navbar-brand" href="#">iAmbulansiya</a>
                </div>
                <div class="collapse navbar-collapse" id="myNavbar">
                    <ul class="nav navbar-nav">
                        <li class="active"><a href="#">Home</a></li>
                        <li><a href="#">Page 1</a></li>
                        <li><a href="#">Page 2</a></li> 
                        <li><a href="#">Page 3</a></li> 
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        <li><a href="#"><span class="glyphicon glyphicon-user"></span> Sign Up</a></li>
                        <li><a href="#"><span class="glyphicon glyphicon-log-in"></span> Login</a></li>
                    </ul>
                </div>
            </div>
        </nav>




        <div id="map"></div>   


        <button id="button_reload" onclick="initMap()">back</button>









        <script>
            var map;
            function getLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(showPosition);

                } else {
                    alert("Geolocation is not supported by this browser.");
                }
            }


            function showPosition(position) {
                lat_1 = position.coords.latitude;
                lng_1 = position.coords.longitude;
                console.log(lat_1,lng_1);
                initMap();
            }

            var infowindow;
            var directionsService;
            var emergency_marker = [];

            function initMap() {
                getLocation();
                var currlocation = {lat: lat_1, lng: lng_1};

                map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 15,
                    disableDefaultUI: true,
                    styles: [
                        {
                            featureType: 'all',
                            stylers: [
                                { saturation: -80 }
                            ]
                        },{
                            featureType: 'road.arterial',
                            elementType: 'geometry',
                            stylers: [
                                { hue: '#00ffee' },
                                { saturation: 50 }
                            ]
                        },{
                            featureType: 'poi.business',
                            elementType: 'labels',
                            stylers: [
                                { visibility: 'off' }
                            ]
                        }
                    ]
                });

                var trafficLayer = new google.maps.TrafficLayer();
                trafficLayer.setMap(map);

                var bounds = new google.maps.LatLngBounds();

                google.maps.event.addListener(map, 'click', function(e) {
                    if (confirm("Do you want to add an Emergency icon here?") ) {
                        placeMarker(e.latLng, map);
                    }
                });


                var hostpital_list = hospital_data;
                var infoWindow = new google.maps.InfoWindow(), marker, i;
                for( i = 0; i < hostpital_list.length; i++ ) {
                    var position = new google.maps.LatLng( hostpital_list[i].location.lat,hostpital_list[i].location.long);
                    bounds.extend(position);
                    marker = new google.maps.Marker({
                        position: position,
                        map: map,
                        title: hostpital_list[i].name,
                        icon: 'resources/images/hospital_32.png'
                    });

                    google.maps.event.addListener(marker, 'click', (function(marker, i) {
                        return function() {
                            infoWindow.setContent(hostpital_list[i].name);
                            infoWindow.open(map, marker);
                        }
                    })(marker, i));

                    map.fitBounds(bounds);
                }
                var boundsListener = google.maps.event.addListener((map), 'bounds_changed', function(event) {
                    this.setZoom(14);
                    google.maps.event.removeListener(boundsListener);
                });
                initEmergencyMarkers();

                var lineSymbol = {
                    path: 'M 0,-1 0,1',
                    strokeOpacity: 1,
                    scale: 4
                };

                var line = new google.maps.Polyline({
                    path: coords,
                    strokeOpacity: 0,
                    icons: [{
                        icon: lineSymbol,
                        offset: '0',
                        repeat: '20px'
                    }],
                    map: map
                });
                //marikinaBorder.setMap(map);
            }

            function initEmergencyMarkers(){
                for(var i = 0; i<emergency_marker.length; i++){
                    console.log("init emergency marker"+emergency_marker[i]);
                    //var position = new google.maps.LatLng( emergency_marker[i].position);
                    var marker = new google.maps.Marker({
                        position: emergency_marker[i],
                        map: map,
                        icon: 'resources/images/emergency_32.png',
                        title: "emergency at: "+i
                    });

                    var infoEmergency = new google.maps.InfoWindow({
                        content: '<p>Emergency!!!</p>'+
                        '<button onclick="removeMarker('+i+')">remove '+i+'</button>'
                    });
                    google.maps.event.addListener(marker, 'click', (function(marker, i) {
                        return function() {
                            infoEmergency.setContent(marker);
                            infoEmergency.open(map, marker);
                        }
                    })(marker, i));
                }
            }

            function placeMarker(position, map) {
                var emergencymarker = new google.maps.Marker({
                    position: position,
                    map: map,
                    icon: 'resources/images/emergency_32.png',
                });

                var index = emergency_marker.length;
                var infoEmergency = new google.maps.InfoWindow({
                    content: '<p>Emergency!!!</p>'+
                    '<button onclick="removeMarker('+index+')">remove</button>'+
                    '<button onclick="setDestination('+index+')">set destination</button>'
                });
                infoEmergency.open(map, emergencymarker);

                google.maps.event.addListener(emergencymarker, 'click', function() {
                    infoEmergency.open(map, emergencymarker);
                });
                console.log("position: "+position);

                /*map.panTo(position);*/
                emergency_marker.push(position);
            }

            function clearMarkers() {
                setMapOnAll(null);
                initMap();
            }

            function removeMarker(position){
                alert('remove: '+position);
                emergency_marker.splice(position,1);
                initMap();
            }

            function setDestination(position){
                /*alert('remove: '+position);
                emergency_marker.splice(position,1);
                initMap();*/
                var nearestHospital = getNearestHospital(emergency_marker[position]);


            }
            var min = null;
            function getNearestHospital(emergency_location){
                var hospital_list = hospital_data;
                var optimal_hospital = null;
                min = 10000;
                //console.log("emergency "+emergency_location.lat+" , "+emergency_location.longitude);
                
                var s = JSON.stringify(emergency_location);
                var emergency = JSON.parse(s);
                console.log("emergency %o",emergency);
                for(var i = 0; i<hospital_list.length; i++){
                    var cost = costFunction(hospital_list[i],emergency);

                    if(cost<min){
                        min = cost;
                        optimal_hospital = hospital_list[i];
                    }
                }
                if(confirm("best place "+optimal_hospital.name+" do you want to proceed?")){
                    directMap(optimal_hospital,emergency);
                }
            }

            function costFunction(hospital, emergency) {
                console.log("hospital %o",hospital);
                console.log("emergency "+emergency.lat+" , "+emergency.lng);

                //d = sqrt( x1-x2) + y )
                var cost = Math.sqrt( 
                    Math.pow((hospital.location.lat-emergency.lat),2)
                    +Math.pow((hospital.location.long-emergency.lng),2 ));//distance formula
                console.log("cost: "+cost);
                return cost;

            }

           
            //--------------------------------------------------------------set map
            function directMap(hospital,emergency) {
                var directionsService = new google.maps.DirectionsService;
                var directionsDisplay = new google.maps.DirectionsRenderer;
                var map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 15,
                    disableDefaultUI: true,
                    styles: [
                        {
                            featureType: 'all',
                            stylers: [
                                { saturation: -80 }
                            ]
                        },{
                            featureType: 'road.arterial',
                            elementType: 'geometry',
                            stylers: [
                                { hue: '#00ffee' },
                                { saturation: 50 }
                            ]
                        },{
                            featureType: 'poi.business',
                            elementType: 'labels',
                            stylers: [
                                { visibility: 'off' }
                            ]
                        }
                    ],
                    center: {lat: hospital.location.lat, lng: hospital.location.long}
                });
                directionsDisplay.setMap(map);
                calculateAndDisplayRoute(directionsService, directionsDisplay, hospital, emergency);
            }

            function calculateAndDisplayRoute(directionsService, directionsDisplay,hospital,emergency) {
                try{
                    directionsService.route({
                        origin: { lat: hospital.location.lat, lng: hospital.location.long },
                        destination: {lat: emergency.lat, lng: emergency.lng },
                        travelMode: 'DRIVING'
                    }, function(response, status) {
                        if (status === 'OK') {
                            directionsDisplay.setDirections(response);
                        } else {
                            window.alert('Directions request failed due to ' + status);
                        }
                    });
                }catch(err){
                    directionsService.route({
                        origin: { lat: hospital.location.lat, lng: hospital.location.long },
                        destination: {lat: emergency.lat, lng: emergency.lng },
                        travelMode: 'DRIVING'
                    }, function(response, status) {
                        if (status === 'OK') {
                            directionsDisplay.setDirections(response);
                        } else {
                            window.alert('Directions request failed due to ' + status);
                        }
                    });
                }
            }


        </script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBymq4YRMhZoMwnPUd2SfyzQQLEvUtafkM&libraries=places&callback=getLocation"
                async defer></script>
    </body>
</html>
